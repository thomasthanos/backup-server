<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ file.original_name }} - View File</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Local Plyr CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/plyr.css') }}">
    <style>
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 50;
            flex-direction: column;
            display: none;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .plyr-container {
            position: relative;
        }
        
        .plyr {
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>
<body class="dashboard">
    <nav class="navbar">
        <div class="navbar-brand">üìÅ File Server</div>
        <div class="navbar-menu">
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('account') }}">Account</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1>{{ file.original_name }}</h1>
            <p>Preview of your file</p>
        </div>

        <div class="file-preview-card">
            {% if is_video %}
                <div class="plyr-container">
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="loading-spinner"></div>
                        <div id="loadingText">Loading video...</div>
                    </div>
                    <video id="player" playsinline controls preload="auto">
                        <source src="{{ url_for('serve_file', file_id=file['id']) }}" type="{{ file.mimetype }}">
                        Your browser doesn't support HTML5 video.
                    </video>
                </div>

                <!-- Local Plyr JS -->
                <script src="{{ url_for('static', filename='js/plyr.js') }}"></script>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const player = new Plyr('#player', {
                            controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
                            speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
                            settings: ['speed'],
                        });

                        const loadingOverlay = document.getElementById('loadingOverlay');
                        const loadingText = document.getElementById('loadingText');
                        const video = document.getElementById('player');
                        
                        let loadingTimeout;
                        let lastSeekTime = 0;

                        function showLoading(message = 'Loading video...', duration = 2000) {
                            loadingText.textContent = message;
                            loadingOverlay.style.display = 'flex';
                            
                            if (loadingTimeout) {
                                clearTimeout(loadingTimeout);
                            }
                            
                            loadingTimeout = setTimeout(() => {
                                loadingOverlay.style.display = 'none';
                            }, duration);
                        }

                        function hideLoading() {
                            loadingOverlay.style.display = 'none';
                            if (loadingTimeout) {
                                clearTimeout(loadingTimeout);
                            }
                        }

                        // Initial load
                        showLoading('Preparing video...', 2000);

                        // Video events
                        video.addEventListener('canplay', function() {
                            hideLoading();
                        });

                        video.addEventListener('playing', function() {
                            hideLoading();
                        });

                        video.addEventListener('seeking', function() {
                            const currentTime = Date.now();
                            const timeSinceLastSeek = currentTime - lastSeekTime;
                            
                            // If rapid seeks (within 2 seconds), show longer loading
                            if (timeSinceLastSeek < 2000) {
                                showLoading('Loading new position...', 4000);
                            } else {
                                showLoading('Buffering...', 3000);
                            }
                            
                            lastSeekTime = currentTime;
                        });

                        video.addEventListener('seeked', function() {
                            // Loading will auto-hide based on the timeout
                        });

                        video.addEventListener('waiting', function() {
                            showLoading('Buffering...', 3000);
                        });

                        video.addEventListener('error', function() {
                            hideLoading();
                        });

                        // Safety timeout
                        setTimeout(hideLoading, 10000);
                    });
                </script>

            {% elif is_audio %}
                <div class="plyr-container">
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="loading-spinner"></div>
                        <div>Loading audio...</div>
                    </div>
                    <audio id="player" controls preload="auto">
                        <source src="{{ url_for('serve_file', file_id=file['id']) }}" type="{{ file.mimetype }}">
                    </audio>
                </div>
                
                <script src="{{ url_for('static', filename='js/plyr.js') }}"></script>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const player = new Plyr('#player', {
                            controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'settings'],
                            speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
                            settings: ['speed'],
                        });

                        const loadingOverlay = document.getElementById('loadingOverlay');
                        const audio = document.getElementById('player');

                        loadingOverlay.style.display = 'flex';
                        
                        audio.addEventListener('canplay', function() {
                            loadingOverlay.style.display = 'none';
                        });

                        audio.addEventListener('seeking', function() {
                            loadingOverlay.style.display = 'flex';
                            setTimeout(() => {
                                loadingOverlay.style.display = 'none';
                            }, 3000);
                        });

                        setTimeout(() => {
                            loadingOverlay.style.display = 'none';
                        }, 3000);
                    });
                </script>

            {% elif is_image %}
                <img src="{{ url_for('serve_file', file_id=file['id']) }}" alt="{{ file.original_name }}" style="max-width: 100%; height: auto; border-radius: 8px;">

            {% else %}
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üìÑ</div>
                    <h3>Preview Not Available</h3>
                    <p>This file type cannot be previewed in the browser.</p>
                    <a href="{{ url_for('download_file', file_id=file['id']) }}" class="btn-download" style="display: inline-block; margin-top: 20px;">
                        ‚¨áÔ∏è Download File
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</body>
</html>