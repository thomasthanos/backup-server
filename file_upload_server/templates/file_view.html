<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ file.original_name }} - View File</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Plyr CSS -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
    <style>
        /* Streaming enhancements */
        .video-container {
            position: relative;
            max-width: 100%;
            margin: 0 auto;
            background: #000;
        }
        
        .plyr-container {
            position: relative;
        }
        
        .streaming-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 100;
            display: none;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 50;
            flex-direction: column;
            display: none;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .file-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .file-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .file-info-label {
            font-weight: bold;
            color: #666;
        }
    </style>
</head>
<body class="dashboard">
    <nav class="navbar">
        <div class="navbar-brand">üìÅ File Server</div>
        <div class="navbar-menu">
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('account') }}">Account</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1>{{ file.original_name }}</h1>
            <p>Video streaming - Plays instantly like YouTube</p>
        </div>

        <!-- File Information -->
        <div class="file-info">
            <div class="file-info-row">
                <span class="file-info-label">File Size:</span>
                <span>
                    {% if file.size >= 1024 * 1024 * 1024 %}
                        {{ (file.size / 1024 / 1024 / 1024) | round(2) }} GB
                    {% elif file.size >= 1024 * 1024 %}
                        {{ (file.size / 1024 / 1024) | round(2) }} MB
                    {% elif file.size >= 1024 %}
                        {{ (file.size / 1024) | round(2) }} KB
                    {% else %}
                        {{ file.size }} B
                    {% endif %}
                </span>
            </div>
            <div class="file-info-row">
                <span class="file-info-label">Type:</span>
                <span>{{ file.mimetype }}</span>
            </div>
            <div class="file-info-row">
                <span class="file-info-label">Uploaded:</span>
                <span>{{ file.uploaded.split(' ')[0] }}</span>
            </div>
        </div>

        <div class="file-preview-card">
            {% if is_video %}
                <div class="video-container">
                    <div class="streaming-status" id="streamingStatus">
                        ‚ö° Streaming Ready
                    </div>
                    
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="loading-spinner"></div>
                        <div id="loadingMessage">Preparing video stream...</div>
                        <div style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
                            Streaming large video file...
                        </div>
                    </div>
                    
                    <div class="plyr-container">
                        <video 
                            id="player" 
                            playsinline 
                            controls 
                            crossorigin="anonymous"
                            preload="metadata"
                        >
                            <source src="{{ url_for('serve_file', file_id=file['id']) }}" type="{{ file.mimetype }}">
                            Your browser doesn't support HTML5 video streaming.
                        </video>
                    </div>
                </div>

                <!-- Download Button -->
                <div style="text-align: center; margin-top: 20px;">
                    <a href="{{ url_for('download_file', file_id=file['id']) }}" class="btn-download">
                        ‚¨áÔ∏è Download Original File
                    </a>
                </div>

                <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const player = new Plyr('#player', {
                            // Enhanced controls
                            controls: [
                                'play-large',
                                'play',
                                'progress',
                                'current-time',
                                'duration',
                                'mute',
                                'volume',
                                'settings',
                                'fullscreen'
                            ],
                            
                            // Settings
                            settings: ['quality', 'speed'],
                            
                            // Speed options
                            speed: { 
                                selected: 1, 
                                options: [0.5, 0.75, 1, 1.25, 1.5, 2] 
                            },
                            
                            // Quality options
                            quality: {
                                default: 1080,
                                options: [4320, 2160, 1440, 1080, 720, 480, 360]
                            },
                            
                            // Seek time in seconds
                            seekTime: 10,
                            
                            // Disable unnecessary features for performance
                            loadSprite: false,
                            iconUrl: false,
                            
                            // Storage
                            storage: { enabled: false },
                            
                            // Tooltips
                            tooltips: { controls: true, seek: true }
                        });

                        // Get DOM elements
                        const streamingStatus = document.getElementById('streamingStatus');
                        const loadingOverlay = document.getElementById('loadingOverlay');
                        const loadingMessage = document.getElementById('loadingMessage');
                        const videoElement = document.querySelector('video');

                        // Enhanced event handling for streaming
                        let hasStarted = false;
                        let bufferingTimeout;
                        
                        // Show loading with message
                        function showLoading(message) {
                            loadingMessage.textContent = message;
                            loadingOverlay.style.display = 'flex';
                            streamingStatus.style.display = 'none';
                        }
                        
                        // Hide loading
                        function hideLoading() {
                            loadingOverlay.style.display = 'none';
                            streamingStatus.style.display = 'block';
                        }
                        
                        // Update status
                        function updateStatus(message, isError = false) {
                            streamingStatus.textContent = message;
                            streamingStatus.style.background = isError ? 'rgba(255, 0, 0, 0.7)' : 'rgba(0, 0, 0, 0.7)';
                            console.log('Status:', message);
                        }

                        // Player events
                        player.on('loadstart', () => {
                            console.log('üöÄ Video loading started');
                            showLoading('Initializing video stream...');
                            updateStatus('üîÑ Connecting...');
                        });
                        
                        player.on('loadedmetadata', () => {
                            console.log('üìπ Video metadata loaded');
                            updateStatus('‚ö° Stream Ready');
                        });
                        
                        player.on('loadeddata', () => {
                            console.log('üé¨ Video data loaded - ready to play');
                            hideLoading();
                            updateStatus('‚ö° Streaming Ready');
                            
                            // Try to auto-play when ready
                            if (!hasStarted) {
                                setTimeout(() => {
                                    player.play().catch(e => {
                                        console.log('Auto-play prevented, waiting for user interaction');
                                        updateStatus('‚ñ∂Ô∏è Click play to start');
                                    });
                                }, 500);
                            }
                        });
                        
                        player.on('canplay', () => {
                            console.log('‚ñ∂Ô∏è Video can start playing');
                            hideLoading();
                            if (!hasStarted) {
                                hasStarted = true;
                            }
                        });
                        
                        player.on('canplaythrough', () => {
                            console.log('üí´ Video can play through without stopping');
                            updateStatus('‚ö° Smooth Streaming');
                        });
                        
                        player.on('waiting', () => {
                            console.log('‚è≥ Video buffering...');
                            showLoading('Buffering...');
                            updateStatus('üîÑ Buffering...');
                            
                            // Clear any existing timeout
                            if (bufferingTimeout) {
                                clearTimeout(bufferingTimeout);
                            }
                        });
                        
                        player.on('playing', () => {
                            console.log('üé¨ Video playing');
                            hideLoading();
                            updateStatus('‚ñ∂Ô∏è Now Playing');
                        });
                        
                        player.on('progress', () => {
                            const buffered = player.buffered;
                            if (buffered && buffered.length > 0) {
                                const bufferedEnd = buffered.end(buffered.length - 1);
                                const duration = player.duration;
                                if (duration > 0) {
                                    const bufferedPercent = (bufferedEnd / duration) * 100;
                                    console.log(`üìä Buffered: ${bufferedPercent.toFixed(1)}%`);
                                    updateStatus(`üìä ${bufferedPercent.toFixed(0)}% Buffered`);
                                }
                            }
                        });
                        
                        player.on('seeking', () => {
                            console.log('üéØ User seeking');
                            showLoading('Seeking...');
                        });
                        
                        player.on('seeked', () => {
                            console.log('üéØ Seek completed');
                            hideLoading();
                        });
                        
                        player.on('error', (error) => {
                            console.error('‚ùå Player error:', error);
                            showLoading('Error loading video');
                            updateStatus('‚ùå Streaming Error', true);
                            
                            // Provide helpful error messages
                            const errorMap = {
                                MEDIA_ERR_NETWORK: 'Network error. Please check your connection.',
                                MEDIA_ERR_DECODE: 'Video format not supported.',
                                MEDIA_ERR_SRC_NOT_SUPPORTED: 'Video format not supported.'
                            };
                            
                            if (videoElement.error) {
                                const errorMsg = errorMap[videoElement.error.code] || 'Unknown error occurred';
                                loadingMessage.textContent = errorMsg;
                            }
                        });

                        player.on('ended', () => {
                            updateStatus('‚úÖ Playback Complete');
                        });

                        // Keyboard shortcuts
                        document.addEventListener('keydown', (e) => {
                            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                            
                            switch(e.key) {
                                case ' ':
                                case 'k':
                                    e.preventDefault();
                                    player.togglePlay();
                                    break;
                                case 'f':
                                    e.preventDefault();
                                    player.fullscreen.toggle();
                                    break;
                                case 'm':
                                    e.preventDefault();
                                    player.muted = !player.muted;
                                    break;
                                case 'ArrowLeft':
                                    e.preventDefault();
                                    player.rewind(10);
                                    break;
                                case 'ArrowRight':
                                    e.preventDefault();
                                    player.forward(10);
                                    break;
                            }
                        });

                        // Display video duration when available
                        const checkDuration = setInterval(() => {
                            if (player.duration && player.duration > 0) {
                                const minutes = Math.floor(player.duration / 60);
                                const seconds = Math.floor(player.duration % 60);
                                console.log(`‚è±Ô∏è Video duration: ${minutes}:${seconds.toString().padStart(2, '0')}`);
                                clearInterval(checkDuration);
                            }
                        }, 1000);

                        // Initial status
                        updateStatus('üîÑ Initializing...');
                    });
                </script>

            {% elif is_audio %}
                <!-- Audio player code remains the same -->
                <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
                <audio id="player" controls>
                    <source src="{{ url_for('serve_file', file_id=file['id']) }}" type="{{ file.mimetype }}">
                </audio>
                <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const player = new Plyr('#player', {
                            controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'settings'],
                            speed: { selected: 1, options: [0.5, 0.75, 1, 1.25, 1.5, 2] },
                            settings: ['speed'],
                        });
                    });
                </script>
            {% elif is_image %}
                <img src="{{ url_for('serve_file', file_id=file['id']) }}" alt="{{ file.original_name }}" style="max-width: 100%; height: auto;">
            {% else %}
                <p>This file type cannot be previewed. You can download it instead.</p>
                <a href="{{ url_for('download_file', file_id=file['id']) }}" class="btn-download">‚¨áÔ∏è Download</a>
            {% endif %}
        </div>
    </div>
</body>
</html>