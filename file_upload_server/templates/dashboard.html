<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - File Upload Server</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dashboard">
    <nav class="navbar">
        <div class="navbar-brand">ğŸ“ File Server</div>
        <div class="navbar-menu">
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('account') }}">Account</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1>Welcome to Your Dashboard</h1>
            <p>Upload, manage, and organize your files securely</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {% if category == 'success' %}
                            âœ“
                        {% elif category == 'error' %}
                            âœ—
                        {% else %}
                            âš 
                        {% endif %}
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Breadcrumbs -->
        {% if current_folder or breadcrumbs %}
        <div class="breadcrumbs">
            <a href="{{ url_for('dashboard') }}" class="breadcrumb-item">ğŸ  Home</a>
            {% for folder in breadcrumbs %}
                <span class="breadcrumb-separator">â€º</span>
                <a href="{{ url_for('dashboard', folder_id=folder.id) }}" class="breadcrumb-item">
                    ğŸ“ {{ folder.name }}
                </a>
            {% endfor %}
        </div>
        {% endif %}

        <div class="upload-section">
            <div class="upload-controls">
                <input type="text" 
                       id="folderNameInput" 
                       class="folder-input" 
                       placeholder="Enter folder name...">
                <button onclick="createFolder()" class="btn-create-folder">
                    ğŸ“ Create Folder
                </button>
            </div>

            {% if is_admin %}
            <!-- Toggle for making a new file public -->
            <div class="public-toggle" style="margin-bottom: 10px;">
                <input type="checkbox" id="publicCheckbox">
                <label for="publicCheckbox">Î”Î·Î¼ÏŒÏƒÎ¹Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ (Î¿ÏÎ±Ï„ÏŒ ÏƒÎµ ÏŒÎ»Î¿Ï…Ï‚)</label>
            </div>
            <!-- Toggle for making a new folder public -->
            <div class="public-toggle" style="margin-bottom: 10px;">
                <input type="checkbox" id="publicFolderCheckbox">
                <label for="publicFolderCheckbox">Î”Î·Î¼ÏŒÏƒÎ¹Î¿Ï‚ Ï†Î¬ÎºÎµÎ»Î¿Ï‚ (Î¿ÏÎ±Ï„ÏŒÏ‚ ÏƒÎµ ÏŒÎ»Î¿Ï…Ï‚)</label>
            </div>
            {% endif %}
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">â˜ï¸</div>
                <h3>Drop your files here</h3>
                <p>or click to browse</p>
                <button type="button" class="upload-btn">Choose File</button>
                <input type="file" id="fileInput" accept="*/*">
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Uploading...</div>
            </div>
        </div>

        <div class="files-section">
            {% if folders or files %}
                <h2>ğŸ“‚ {{ 'Current Folder' if current_folder else 'Your Files & Folders' }}</h2>
                
                <!-- A compact, scrollable table for folders and files -->
                <div class="item-table">
                    <div class="table-header">
                        <div class="col-name">Name</div>
                        <div class="col-size">Size</div>
                        <div class="col-date">Date</div>
                        <div class="col-actions">Actions</div>
                    </div>
                    <!-- Render folders as rows -->
                    {% for folder in folders %}
                    <div class="table-row folder-row">
                        <div class="col-name">
                            <span class="table-icon">ğŸ“</span>
                            <span class="name-text">{{ folder.name }}</span>
                            {% if folder.is_public %}
                                <span title="Public folder" class="public-indicator">ğŸŒ</span>
                            {% endif %}
                        </div>
                        <div class="col-size">
                            {% if folder.size >= 1024 * 1024 * 1024 %}
                                {{ (folder.size / 1024 / 1024 / 1024) | round(2) }} GB
                            {% elif folder.size >= 1024 * 1024 %}
                                {{ (folder.size / 1024 / 1024) | round(2) }} MB
                            {% elif folder.size >= 1024 %}
                                {{ (folder.size / 1024) | round(2) }} KB
                            {% else %}
                                {{ folder.size }} B
                            {% endif %}
                        </div>
                        <div class="col-date">{{ folder.created.split(' ')[0] }}</div>
                        <div class="col-actions">
                            <a href="{{ url_for('dashboard', folder_id=folder.id) }}" class="btn-open">
                                <span class="action-icon">ğŸ“‚</span>
                                <span class="action-text">Open</span>
                            </a>
                            {% if folder.user_id == current_user_id or is_admin %}
                            <button onclick="deleteFolder('{{ folder.id }}')" class="btn-delete">
                                <span class="action-icon">ğŸ—‘ï¸</span>
                                <span class="action-text">Delete</span>
                            </button>
                            {% endif %}
                            {% if is_admin and not folder.is_public %}
                            <button onclick="if (window.makeFolderPublic){ window.makeFolderPublic('{{ folder.id }}'); }" class="btn-make-public-folder">
                                <span class="action-icon">ğŸŒ</span>
                                <span class="action-text">Public</span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Render files as rows -->
                    {% for file in files %}
                    {% set ext = file.original_name.rsplit('.', 1)[-1].lower() if '.' in file.original_name else '' %}
                    {% set icon_path = 'icons/default.svg' %}
                    {% if ext in ['jpg','jpeg','png','gif','bmp','tiff','webp'] or file.mimetype.startswith('image/') %}
                        {% set icon_path = 'icons/image.svg' %}
                    {% elif ext in ['mp4','avi','mkv','mov','wmv','flv','m4v'] or file.mimetype.startswith('video/') %}
                        {% set icon_path = 'icons/video.svg' %}
                    {% elif ext in ['mp3','wav','flac','aac','ogg','m4a'] or file.mimetype.startswith('audio/') %}
                        {% set icon_path = 'icons/audio.svg' %}
                    {% elif ext in ['pdf'] or 'pdf' in file.mimetype %}
                        {% set icon_path = 'icons/document.svg' %}
                    {% elif ext in ['zip','rar','7z','tar','gz','bz2','xz'] or 'zip' in file.mimetype or 'rar' in file.mimetype %}
                        {% set icon_path = 'icons/archive.svg' %}
                    {% elif ext in ['doc','docx','odt','rtf','txt'] or 'word' in file.mimetype or 'document' in file.mimetype %}
                        {% set icon_path = 'icons/document.svg' %}
                    {% elif ext in ['xls','xlsx','csv','ods'] or 'excel' in file.mimetype or 'sheet' in file.mimetype %}
                        {% set icon_path = 'icons/spreadsheet.svg' %}
                    {% elif ext in ['exe','msi','dmg','pkg','apk','app'] %}
                        {% set icon_path = 'icons/executable.svg' %}
                    {% elif ext in ['py','js','ts','jsx','tsx','html','css','c','cpp','cc','cxx','java','cs','rb','go','rs','php','swift','kt','kts','dart','scala','lua','json','xml','yaml','yml'] %}
                        {% set icon_path = 'icons/code.svg' %}
                    {% endif %}
                    {% set is_video = ext in ['mp4','avi','mkv','mov','wmv','flv','m4v'] or file.mimetype.startswith('video/') %}
                    {% set is_audio = ext in ['mp3','wav','flac','aac','ogg','m4a'] or file.mimetype.startswith('audio/') %}
                    {% set is_image = ext in ['jpg','jpeg','png','gif','bmp','tiff','webp'] or file.mimetype.startswith('image/') %}

                    {# Determine if the video format is supported for inline preview (HTML5).  Use the same
                       list as in the view_file route.  If not supported (e.g. AVI, MKV, WMV, FLV), we will not
                       show a play button and the filename will not be clickable. #}
                    {% set supported_video_exts = ['mp4','m4v','mov','webm','ogv','ogg'] %}
                    {% set can_preview_video = ext in supported_video_exts or file.mimetype in ['video/mp4','video/webm','video/ogg','video/quicktime'] %}
                    {% set previewable = can_preview_video or is_audio or is_image %}
                    <div class="table-row file-row">
                        <div class="col-name">
                            <img src="{{ url_for('static', filename=icon_path) }}" alt="icon" class="table-icon-img">
                            {% if previewable %}
                                <!-- Make previewable file names clickable to open the viewer -->
                                <a href="{{ url_for('view_file', file_id=file.id) }}" class="name-text file-link">{{ file.original_name }}</a>
                            {% else %}
                                <span class="name-text">{{ file.original_name }}</span>
                            {% endif %}
                            {% if file.is_public %}
                                <span title="Public file" class="public-indicator">ğŸŒ</span>
                            {% endif %}
                        </div>
                        <div class="col-size">
                            {% if file.size >= 1024 * 1024 * 1024 %}
                                {{ (file.size / 1024 / 1024 / 1024) | round(2) }} GB
                            {% elif file.size >= 1024 * 1024 %}
                                {{ (file.size / 1024 / 1024) | round(2) }} MB
                            {% elif file.size >= 1024 %}
                                {{ (file.size / 1024) | round(2) }} KB
                            {% else %}
                                {{ file.size }} B
                            {% endif %}
                        </div>
                        <div class="col-date">{{ file.uploaded.split(' ')[0] }}</div>
                        <div class="col-actions">
                            {% if can_preview_video %}
                                <a href="{{ url_for('view_file', file_id=file.id) }}" class="btn-view">
                                    <span class="action-icon">â–¶ï¸</span>
                                    <span class="action-text">Play</span>
                                </a>
                            {% elif is_audio %}
                                <a href="{{ url_for('view_file', file_id=file.id) }}" class="btn-view">
                                    <span class="action-icon">ğŸµ</span>
                                    <span class="action-text">Listen</span>
                                </a>
                            {% elif is_image %}
                                <a href="{{ url_for('view_file', file_id=file.id) }}" class="btn-view">
                                    <span class="action-icon">ğŸ‘ï¸</span>
                                    <span class="action-text">View</span>
                                </a>
                            {% endif %}
                            <a href="{{ url_for('download_file', file_id=file.id) }}" class="btn-download">
                                <span class="action-icon">â¬‡ï¸</span>
                                <span class="action-text">Download</span>
                            </a>
                            {% if file.user_id == current_user_id or is_admin %}
                            <button onclick="deleteFile('{{ file.id }}')" class="btn-delete">
                                <span class="action-icon">ğŸ—‘ï¸</span>
                                <span class="action-text">Delete</span>
                            </button>
                            {% endif %}
                            {% if is_admin and not file.is_public %}
                            <button onclick="makePublic('{{ file.id }}')" class="btn-make-public">
                                <span class="action-icon">ğŸŒ</span>
                                <span class="action-text">Public</span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ”­</div>
                    <h3>No files or folders yet</h3>
                    <p>Create a folder or upload your first file to get started!</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Custom Modal for Alerts and Confirmations -->
    <div id="modalOverlay" class="modal-overlay">
        <div id="customModal" class="modal-card">
            <div id="modalMessage" class="modal-message">Message</div>
            <div class="modal-actions">
                <button id="modalCancel" class="modal-btn modal-cancel">Cancel</button>
                <button id="modalOk" class="modal-btn modal-ok">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Pass the current folder's ID to JavaScript in a way that doesn't confuse linters or TypeScript.
        // We render the ID as a string via Jinja and then parse it in JavaScript. If there is no current
        // folder, the string will be empty and we fall back to null.
        const currentFolderId = (() => {
            const idStr = "{{ current_folder.id if current_folder else '' }}";
            return idStr ? parseInt(idStr) : null;
        })();
    </script>
    <!-- main.js includes logic for uploading files and managing folders.  To include the public flag when creating
         a folder, update the createFolder() function in main.js to read the state of the publicFolderCheckbox
         and append a 'public' field to the FormData when sending the request.  -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>